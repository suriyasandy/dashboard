import pandas as pd
import numpy as np

def create_threshold_bucket_summary(df, bucket_size=0.4):
    # 1. Get max deviation to determine range
    max_dev = df['DeviationPercent'].max()
    bins = np.arange(0, max_dev + bucket_size, bucket_size)

    # 2. Create labeled bins: "0.0–0.4", "0.4–0.8", etc.
    labels = [f"{round(bins[i], 1)}–{round(bins[i+1], 1)}" for i in range(len(bins)-1)]

    # 3. Assign bins
    df['Bucket'] = pd.cut(df['DeviationPercent'], bins=bins, labels=labels, include_lowest=True)

    # 4. Pivot table for count summary
    summary_df = df.pivot_table(
        index='Bucket',
        columns='Currency',
        values='DeviationPercent',
        aggfunc='count',
        fill_value=0
    )

    return summary_df
